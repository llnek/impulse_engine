!function(t){"use strict";"object"==typeof module&&module&&"object"==typeof module.exports?t=module.exports:"object"==typeof exports&&exports&&(t=exports);t["io.czlab.impulse_engine.core"]=function(){const i=t["io.czlab.mcfud.core"](),e=t["io.czlab.mcfud.math"](),s=t["io.czlab.mcfud.gfx"](),o=t["io.czlab.mcfud.geo2d"](),n=(i.u,i.is);class c{constructor(t,i,e,s){this.m00=t,this.m01=i,this.m10=e,this.m11=s}clone(){return new c(this.m00,this.m01,this.m10,this.m11)}set(t){let i=Math.cos(t),e=Math.sin(t);return this.m00=i,this.m01=-e,this.m10=e,this.m11=i,this}abs(){return new c(Math.abs(this.m00),Math.abs(this.m01),Math.abs(this.m10),Math.abs(this.m11))}axisX(){return e.V2(this.m00,this.m10)}axisY(){return e.V2(this.m01,this.m11)}transpose(){return new c(this.m00,this.m10,this.m01,this.m11)}}c.mul=function(t,i){return n.vec(i)?e.V2(t.m00*i[0]+t.m01*i[1],t.m10*i[0]+t.m11*i[1]):new c(t.m00*i.m00+t.m01*i.m10,t.m00*i.m01+t.m01*i.m11,t.m10*i.m00+t.m11*i.m10,t.m10*i.m01+t.m11*i.m11)};const r={ePoly:100,eCircle:200,M2:c,dt:1/60,gravity:e.V2(0,50)};return t["io.czlab.impulse_engine.shape"](r,i,e),t["io.czlab.impulse_engine.body"](r,i,e),t["io.czlab.impulse_engine.manifold"](r,i,e),t["io.czlab.impulse_engine.collision"](r,i,e),t["io.czlab.impulse_engine.scene"](r,i,e,s,o),r}}(this),function(t){"use strict";"object"==typeof module&&module&&"object"==typeof module.exports?t=module.exports:"object"==typeof exports&&exports&&(t=exports),t["io.czlab.impulse_engine.shape"]=function(i,e,s){const o=t["io.czlab.mcfud.geo2d"](),n=t["io.czlab.mcfud.gfx"](),c=i.M2,r=e.u;class l{constructor(){this.body=null,this.u=new c}isCircular(){return!1}}class h extends l{constructor(t){super(),this.radius=t}isCircular(){return!0}getAABB(){let t=this.body.position[0]+this.radius,i=this.body.position[0]-this.radius,e=this.body.position[1]+this.radius,s=this.body.position[1]-this.radius;return new o.Rect(i,s,t-i,e-s)}clone(){return new h(this.radius)}initialize(){this.computeMass(1)}computeMass(t){let i=this.radius*this.radius;this.body.m=Math.PI*i*t,this.body.I=this.body.m*i,this.body.im=this.body.m?1/this.body.m:0,this.body.iI=this.body.I?1/this.body.I:0}setOrient(t){return this.u.set(t),this}draw(t){t.save(),t.strokeStyle=this.body.rgb,n.drawCircle(t,this.body.position[0],this.body.position[1],this.radius);let i=c.mul(this.u,s.V2(1,0));i=s.vecMul(i,this.radius),i=s.vecAdd(i,this.body.position),t.strokeStyle="green",n.drawLine(t,this.body.position[0],this.body.position[1],i[0],i[1]),t.restore()}getType(){return i.eCircle}}class u extends l{constructor(){super(),this.points=[],this.normals=[]}getAABB(){let t=this._calcPoints(),i=1/0,e=1/0,s=-1/0,n=-1/0;for(let o,c=0;c<t.length;++c)o=t[c],o[0]<i&&(i=o[0]),o[0]>s&&(s=o[0]),o[1]<e&&(e=o[1]),o[1]>n&&(n=o[1]);return new o.Rect(i,e,s-i,n-e)}initialize(){return this.computeMass(1),this}clone(){let t=new u;t.u=this.u.clone();for(let i=0;i<this.points.length;++i)t.points[i]=s.vecClone(this.points[i]),t.normals[i]=s.vecClone(this.normals[i]);return t}computeMass(t){let i=s.V2(),e=0,o=0;const n=1/3,c=this.points.length;for(let t=0;t<c;++t){let r=this.points[t],l=(t+1)%c,h=this.points[l],u=s.vec2Cross(r,h),a=.5*u;e+=a,i=s.vecAdd(i,s.vecMul(s.vecAdd(r,h),a*n)),o+=.25*n*u*(r[0]*r[0]+h[0]*r[0]+h[0]*h[0]+(r[1]*r[1]+h[1]*r[1]+h[1]*h[1]))}i=s.vecMul(i,1/e);for(let t=0;t<c;++t)s.vecSubSelf(this.points[t],i);return this.body.m=t*e,this.body.im=this.body.m?1/this.body.m:0,this.body.I=o*t,this.body.iI=this.body.I?1/this.body.I:0,this}setOrient(t){return this.u.set(t),this}_calcPoints(){let t=[];for(let i=0;i<this.points.length;++i)t.push(s.vecAdd(this.body.position,c.mul(this.u,this.points[i])));return t}draw(t){t.save(),t.strokeStyle=this.body.rgb,n.drawPoints(t,this._calcPoints()),t.restore()}getType(){return i.ePoly}setBox(t,i){return this.normals.length=0,this.points.length=0,this.points[0]=s.V2(-t,-i),this.points[1]=s.V2(t,-i),this.points[2]=s.V2(t,i),this.points[3]=s.V2(-t,i),this.normals[0]=s.V2(0,-1),this.normals[1]=s.V2(1,0),this.normals[2]=s.V2(0,1),this.normals[3]=s.V2(-1,0),this}set(t){let i=t.length;r.assert(i>2&&i<=64);let e=0,o=t[0][0];for(let n,c=1;c<i;++c)n=t[c][0],n>o?(o=n,e=c):s.fuzzyEq(n,o)&&t[c][1]<t[e][1]&&(e=c);let n=new Array(64),c=0,l=e;for(;;){n[c]=l;let o=0;for(let e=1;e<i;++e){if(o===l){o=e;continue}let i=s.vecSub(t[o],t[n[c]]),r=s.vecSub(t[e],t[n[c]]),h=s.vec2Cross(i,r);h<0&&(o=e),s.fuzzyZero(h)&&s.vecLen2(r)>s.vecLen2(i)&&(o=e)}if(++c,l=o,o===e)break}this.normals.length=0,this.points.length=0;for(let i=0;i<c;++i)this.points[i]=t[n[i]].slice();for(let t=0;t<c;++t){let i=(t+1)%c,e=s.vecSub(this.points[i],this.points[t]);r.assert(s.vecLen2(e)>s.EPSILON*s.EPSILON),this.normals[t]=s.vecUnit(s.V2(e[1],-e[0]))}return this}getSupport(t){let i,e=-1/0;for(let o,n,c=0;c<this.points.length;++c)n=this.points[c],o=s.vecDot(n,t),o>e&&(i=n,e=o);return i}}return r.inject(i,{Circle:h,Polygon:u})}}(this),function(t){"use strict";"object"==typeof module&&module&&"object"==typeof module.exports?t=module.exports:"object"==typeof exports&&exports&&(t=exports),t["io.czlab.impulse_engine.body"]=function(t,i,e){const s=i.u;return s.inject(t,{Body:class{constructor(t,i,o){this.shape=t,this.shape.body=this,this.position=e.V2(i,o),this.velocity=e.V2(),this.angularVelocity=0,this.torque=0,this.rgb="blue",this.force=e.V2(),this.staticFriction=.5,this.dynamicFriction=.3,this.restitution=.2,this.orient=s.randFloat(-Math.PI,Math.PI),this.shape.isCircular()&&(this.rgb="magenta"),this.shape.initialize()}applyForce(t){return this.force=e.vecAdd(this.force,t),this}applyImpulse(t,i){return e.vecAddSelf(this.velocity,e.vecMul(t,this.im)),this.angularVelocity+=this.iI*e.vec2Cross(i,t),this}setStatic(){return this.I=0,this.iI=0,this.m=0,this.im=0,this}setOrient(t){return this.orient=t,this.shape.setOrient(t),this}}})}}(this),function(t){"use strict";"object"==typeof module&&module&&"object"==typeof module.exports?t=module.exports:"object"==typeof exports&&exports&&(t=exports),t["io.czlab.impulse_engine.manifold"]=function(t,i,e){const s=i.u;return s.inject(t,{Manifold:class{constructor(t,i){this.A=t,this.B=i,this.penetration=0,this.normal=e.V2(),this.contacts=[e.V2(),e.V2()],this.contact_count=0,this.e=0,this.df=0,this.sf=0}solve(){return t.dispatch(this.A.shape.getType(),this.B.shape.getType()).call(t,this,this.A,this.B),this}initialize(){this.e=Math.min(this.A.restitution,this.B.restitution),this.sf=Math.sqrt(this.A.staticFriction*this.B.staticFriction),this.df=Math.sqrt(this.A.dynamicFriction*this.B.dynamicFriction);for(let i=0;i<this.contact_count;++i){let s=e.vecSub(this.contacts[i],this.A.position),o=e.vecSub(this.contacts[i],this.B.position),n=e.vecAdd(this.B.velocity,e.vec2Cross(this.B.angularVelocity,o));n=e.vecSub(e.vecSub(n,this.A.velocity),e.vec2Cross(this.A.angularVelocity,s)),e.vecLen2(n)<e.vecLen2(e.vecMul(t.gravity,t.dt))+e.EPSILON&&(this.e=0)}return this}applyImpulse(){if(e.fuzzyZero(this.A.im+this.B.im))return this.infiniteMassCorrection(),this;for(let t=0;t<this.contact_count;++t){let i=e.vecSub(this.contacts[t],this.A.position),s=e.vecSub(this.contacts[t],this.B.position),o=e.vecAdd(this.B.velocity,e.vec2Cross(this.B.angularVelocity,s));o=e.vecSub(e.vecSub(o,this.A.velocity),e.vec2Cross(this.A.angularVelocity,i));let n=e.vecDot(o,this.normal);if(n>0)return this;let c=e.vec2Cross(i,this.normal),r=e.vec2Cross(s,this.normal),l=this.A.im+this.B.im+c*c*this.A.iI+r*r*this.B.iI,h=-(1+this.e)*n;h/=l,h/=this.contact_count;let u=e.vecMul(this.normal,h);this.A.applyImpulse(e.vecFlip(u),i),this.B.applyImpulse(u,s),o=e.vecAdd(this.B.velocity,e.vec2Cross(this.B.angularVelocity,s)),o=e.vecSub(e.vecSub(o,this.A.velocity),e.vec2Cross(this.A.angularVelocity,i));let a=e.vecSub(o,e.vecMul(this.normal,e.vecDot(o,this.normal)));a=e.vecUnit(a);let p,d=-e.vecDot(o,a);if(d/=l,d/=this.contact_count,e.fuzzyZero(d))return this;p=Math.abs(d)<h*this.sf?e.vecMul(a,d):e.vecMul(a,-h*this.df),this.A.applyImpulse(e.vecFlip(p),i),this.B.applyImpulse(p,s)}return this}positionalCorrection(){let t=e.vecMul(this.normal,Math.max(this.penetration-.05,0)/(this.A.im+this.B.im)*.4);return e.vecSubSelf(this.A.position,e.vecMul(t,this.A.im)),e.vecAddSelf(this.B.position,e.vecMul(t,this.B.im)),this}infiniteMassCorrection(){return e.vecCopy(this.A.velocity,0,0),e.vecCopy(this.B.velocity,0,0),this}}})}}(this),function(t){"use strict";"object"==typeof module&&module&&"object"==typeof module.exports?t=module.exports:"object"==typeof exports&&exports&&(t=exports),t["io.czlab.impulse_engine.collision"]=function(t,i,e){const s=t.M2,o=i.u,n={};function c(t,i){let o,n=-1/0;for(let c=0;c<t.points.length;++c){let r=t.normals[c],l=t.points[c],h=s.mul(t.u,r),u=i.u.transpose();r=s.mul(u,h);let a=i.getSupport(e.vecFlip(r));l=e.vecAdd(s.mul(t.u,l),t.body.position),e.vecSubSelf(l,i.body.position),l=s.mul(u,l);let p=e.vecDot(r,e.vecSub(a,l));p>n&&(n=p,o=c)}return[n,o]}function r(t,i,s){let n=[s[0],s[1]],c=0,r=e.vecDot(t,s[0])-i,l=e.vecDot(t,s[1])-i;if(r<=0&&(n[c++]=s[0]),l<=0&&(n[c++]=s[1]),r*l<0){let t=r/(r-l);n[c]=e.vecAdd(s[0],e.vecMul(e.vecSub(s[1],s[0]),t)),++c}return s[0]=n[0],s[1]=n[1],o.assert(3!=c),c}return n.dispatch=function(i,e){return i===t.eCircle?e===t.eCircle?this.circleCircle:this.circlePolygon:i===t.ePoly?e===t.eCircle?this.polygonCircle:this.polygonPolygon:void 0},n.circleCircle=function(t,i,s){let o=i.shape,n=s.shape,c=e.vecSub(s.position,i.position),r=e.vecLen2(c),l=o.radius+n.radius;if(r>=l*l)return void(t.contact_count=0);let h=Math.sqrt(r);t.contact_count=1,e.fuzzyZero(h)?(t.penetration=o.radius,t.normal=e.V2(1,0),e.vecSet(t.contacts[0],i.position)):(t.penetration=l-h,t.normal=e.vecDiv(c,h),e.vecSet(t.contacts[0],e.vecAdd(e.vecMul(t.normal,o.radius),i.position)))},n.circlePolygon=function(i,o,n){let c=o.shape,r=n.shape;i.contact_count=0;let l=s.mul(r.u.transpose(),e.vecSub(o.position,n.position)),h=-1/0,u=0;for(let t=0;t<r.points.length;++t){let i=e.vecDot(r.normals[t],e.vecSub(l,r.points[t]));if(i>c.radius)return;i>h&&(h=i,u=t)}let a=r.points[u],p=(u+1)%r.points.length,d=r.points[p];if(h<t.EPSILON)return i.contact_count=1,i.normal=e.vecFlip(s.mul(r.u,r.normals[u])),e.vecSet(i.contacts[0],e.vecAdd(e.vecMul(i.normal,c.radius),o.position)),void(i.penetration=c.radius);let m=e.vecDot(e.vecSub(l,a),e.vecSub(d,a)),v=e.vecDot(e.vecSub(l,d),e.vecSub(a,d));if(i.penetration=c.radius-h,m<=0){if(e.vecDist2(l,a)>c.radius*c.radius)return;i.contact_count=1;let t=e.vecSub(a,l);i.normal=e.vecUnit(s.mul(r.u,t)),e.vecSet(i.contacts[0],e.vecAdd(s.mul(r.u,a),n.position))}else if(v<=0){if(e.vecDist2(l,d)>c.radius*c.radius)return;i.contact_count=1;let t=e.vecSub(d,l);i.normal=e.vecUnit(s.mul(r.u,t)),e.vecSet(i.contacts[0],e.vecAdd(s.mul(r.u,d),n.position))}else{let t=r.normals[u];if(e.vecDot(e.vecSub(l,a),t)>c.radius)return;i.normal=e.vecFlip(s.mul(r.u,t)),e.vecSet(i.contacts[0],e.vecAdd(e.vecMul(i.normal,c.radius),o.position)),i.contact_count=1}},t.polygonCircle=function(t,i,s){this.circlePolygon(t,s,i),e.vecFlipSelf(t.normal)},t.polygonPolygon=function(t,i,o){let n=i.shape,l=o.shape;t.contact_count=0;let[h,u]=c(n,l);if(h>=0)return;let a,p,d,m,[v,f]=c(l,n);if(v>=0)return;e.biasGreater(h,v)?(a=n,p=l,d=u,m=!1):(a=l,p=n,d=f,m=!0);let y=function(t,i,o){let n=t.normals[o];n=s.mul(t.u,n),n=s.mul(i.u.transpose(),n);let c=0,r=1/0;for(let t,s=0;s<i.points.length;++s)t=e.vecDot(n,i.normals[s]),t<r&&(r=t,c=s);let l=e.vecAdd(s.mul(i.u,i.points[c]),i.body.position);return c=(c+1)%i.points.length,[l,e.vecAdd(s.mul(i.u,i.points[c]),i.body.position)]}(a,p,d),b=a.points[d];d=(d+1)%a.points.length;let g=a.points[d];b=e.vecAdd(s.mul(a.u,b),a.body.position),g=e.vecAdd(s.mul(a.u,g),a.body.position);let S=e.vecUnit(e.vecSub(g,b)),A=e.V2(S[1],-S[0]),M=e.vecDot(A,b),z=-e.vecDot(S,b),x=e.vecDot(S,g);if(r(e.vecFlip(S),z,y)<2)return;if(r(S,x,y)<2)return;t.normal=m?e.vecFlip(A):A;let C=0,V=e.vecDot(A,y[0])-M;V<=0?(t.contacts[C]=y[0],t.penetration=-V,++C):t.penetration=0,V=e.vecDot(A,y[1])-M,V<=0&&(t.contacts[C]=y[1],t.penetration+=-V,++C,t.penetration/=C),t.contact_count=C},o.inject(t,n)}}(this),function(t){"use strict";"object"==typeof module&&module&&"object"==typeof module.exports?t=module.exports:"object"==typeof exports&&exports&&(t=exports),t["io.czlab.impulse_engine.scene"]=function(t,i,e,s,o){const n=i.u;function c(i,s){if(e.fuzzyZero(i.im))return;let o=s/2;e.vecAddSelf(i.velocity,e.vecMul(e.vecAdd(e.vecMul(i.force,i.im),t.gravity),o)),i.angularVelocity+=i.torque*i.iI*o}return n.inject(t,{Scene:class{constructor(t,i){this.dt=t,this.bodies=[],this.contacts=[],this.tries=i}step(){this.contacts.length=0;for(let i,s=0;s<this.bodies.length;++s){i=this.bodies[s];for(let o,n,c=s+1;c<this.bodies.length;++c)n=this.bodies[c],e.fuzzyZero(i.im)&&e.fuzzyZero(n.im)||(o=new t.Manifold(i,n).solve(),o.contact_count>0&&this.contacts.push(o))}this.bodies.forEach(t=>c(t,this.dt)),this.contacts.forEach(t=>t.initialize());for(let t=0;t<this.tries;++t)this.contacts.forEach(t=>t.applyImpulse());this.bodies.forEach(t=>function(t,i){e.fuzzyZero(t.im)||(e.vecAddSelf(t.position,e.vecMul(t.velocity,i)),t.orient+=t.angularVelocity*i,t.setOrient(t.orient),c(t,i))}(t,this.dt)),this.contacts.forEach(t=>t.positionalCorrection()),this.bodies.forEach(t=>{e.vecCopy(t.force,0,0),t.torque=0})}render(t){this.bodies.forEach(i=>i.shape.draw(t))}add(i,e,s){let o=new t.Body(i,e,s);return this.bodies.push(o),o}}})}}(this);